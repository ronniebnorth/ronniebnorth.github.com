<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml"
xmlns:fb="http://ogp.me/ns/fb#">
    <head>
        <title>Chloe - Dorian - Phrygian - Lydian - Mixolydian - Aeolian - Locrian - Ionian - Pentatonic</title>
        <meta name="description" content="Chloe 2
        Explore and learn about Scales and Modes">
        <meta name="keywords" 
        content="dorian, phrygian, lydian, mixolydian, aeolian, locrian, ionian, 
        scales, modes, chloe, listen, app, player">
        <link rel="icon" href="https://ronniebnorth.github.io/chloe2/img/ss2017-12-14_11-42-22.jpg">
        <meta property="og:image" content="https://ronniebnorth.github.io/chloe2/img/ss2017-12-14_11-42-22.jpg" />
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">


        <link rel="stylesheet" href="scalemaster.css?version=673334433"/>
        <script src="jquery-3.2.1.min.js"></script>
        <script src="ramda.js"></script>
        <script src="tone.js"></script>
        <!-- polyfill -->
        <script src="./inc/shim/Base64.js" type="text/javascript"></script>
        <script src="./inc/shim/Base64binary.js" type="text/javascript"></script>
        <script src="./inc/shim/WebAudioAPI.js" type="text/javascript"></script>
        <!-- midi.js package -->
        <script src="./js/midi/audioDetect.js" type="text/javascript"></script>
        <script src="./js/midi/gm.js" type="text/javascript"></script>
        <script src="./js/midi/loader.js" type="text/javascript"></script>
        <script src="./js/midi/plugin.audiotag.js" type="text/javascript"></script>
        <script src="./js/midi/plugin.webaudio.js" type="text/javascript"></script>
        <script src="./js/midi/plugin.webmidi.js" type="text/javascript"></script>
        <!-- utils -->
        <script src="./js/util/dom_request_xhr.js" type="text/javascript"></script>
        <script src="./js/util/dom_request_script.js" type="text/javascript"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110149473-1"></script>

<script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110149473-1');
</script>
    </head>
    <body>
  
    <div id="notes_template_container" style="display:none">
        <a class="btn_key">A</a>
        <a class="btn_key">B♭</a>
        <a class="btn_key">B</a>
        <a class="btn_key">C</a>
        <a class="btn_key">D♭</a>
        <a class="btn_key">D</a>
        <a class="btn_key">E♭</a>
        <a class="btn_key">E</a>
        <a class="btn_key">F</a>
        <a class="btn_key">G♭</a>
        <a class="btn_key">G</a>
        <a class="btn_key">A♭</a>

    </div>
    <div id="container">
        <div>
                <div id="myModal" class="modal">
                    <div id="myModalContent" class="modal-content">
                        <label id="closeModal" style="font-size:14pt">close</label>&nbsp;&nbsp;&nbsp;&nbsp;
                        <label id="modeInfo" style="font-size:8pt"></label>&nbsp;&nbsp;&nbsp;&nbsp;
                        <label id="rotateMode" style="font-size:14pt">rotate</label>
                        <br>
                        <canvas id="canvas" modeInfo="" notes="" note_labels="" width="220" height="220" style="background-color:#333"></canvas> 
                    </div>
                </div> 
                <div id="myModal2" class="modal">
                    <div id="myModalContent2" class="modal-content-help">
                        <label id="closeModal2" style="font-size:14pt">close</label>
                        <br>
<p>
Chloe - This app is used for exploring / listening to scales and modes.

Includes all sets of scales from octatonic (8 notes) to tritonic 
(3 notes).
Any scales containing 3 consecutive notes are not generated.

The 7 modes most people are familiar with (Dorian, Phrygian, Lydian...) 
are all located in the 5th diatonic scale (dia-5), and sorted Lydian to 
Locrian, light to dark, augmented to diminished.

Lydian, Ionian, Mixolydian, Dorian, Aeolian, Phrygian, Locrian

The modes are sorted by their level of augmentation.. how many 
steps from root note to the 2nd, then to the 3rd, etc. 

The 2 normally used modes of pentatonic, major and minor, belong to the 
37th  pentatonic scale. (pen-37). The major is 2708, the minor is 2386.
Notice how the major corresponds to Ionian mode, and minor to Aeolian.

Select the mode info string to show the scale viewer.

Searching filters by the information string (110010110110 (3254) dia-0).
Search multiple scales by separating the search terms with a comma.

Example searches: 

To get the Greek Modes and Pentatonic: 
    dia-5,pen-37

To get a specific step pattern, like Ionian (major): 
    101011010101

Since we are accustomed to hearing a small slice of this large spectrum,
most of these will sound strange, or awful. Try droning a single key for a while. 
Once the new mode sinks in, your perspective may start to change.

</p>
                    </div>
                </div> 
                <div>
                    <table align="center" class="controlPanel">
                        <tr>
                            <td>
                                <div class="radio-group">
                                    <label for="mode_filter">Search</label>
                                    <input type="text" id="mode_filter" placeholder="ie.. dia-5,pen-37" style="width:120px"/>
                                    
                                </div>
                         
                                <div class="radio-group">
                                    <input type="radio" id="option-one" value="root" name="play_style">
                                    <label for="option-one">Root</label>
                                    
                                    <input type="radio" id="option-two" value="chord" name="play_style">
                                    <label for="option-two">Chord</label>
            
                                    <input type="radio" id="option-three" value="fills" name="play_style" checked>
                                    <label for="option-three">Root + Fills</label>
            
                                    <input type="radio" id="option-four" value="just_fills" name="play_style">
                                    <label for="option-four">Fills</label>
                                </div>  
                                <div class="radio-group">
                                    <label id="helpLabel" for="option-help">&nbsp;?&nbsp;</label>
                                </div>        
                            </td>
                            <!--td>
                                <label for="points">Volume</label>
                                <input style="width:80px" type="range" name="points" id="points" value="50" min="0" max="100">
                            </td>
                            <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                            <td>
                                <label for="points">Risk</label>
                                <input style="width:80px" type="range" name="points" id="points" value="50" min="0" max="100">
                            </td>
                            <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                            <td>
                                <label for="points">Verbosity</label>
                                <input style="width:80px" type="range" name="points" id="points" value="50" min="0" max="100">
                            </td-->
                        </tr>
                    </table>

                    
                </div>
 
            </div> 

            
        <div id="scales_div" stylex="padding:3px;border-radius: 5px;border: 4px solid #675f6b;"></div>  
        
    </div>
    <script>






const chromatic = ['A','Bb','B','C','Db','D','Eb','E','F','Gb','G','Ab'];
const chromatic_labels = ['A','B♭','B','C','D♭','D','E♭','E','F','G♭','G','A♭'];

let lastVelocity = 100;

const octatonic = [1,1,1,1,1,1,1,0,0,0,0];
let octatonicScales = [];
octatonicScales.group = 'oct';
const diatonic = [1,1,1,1,1,1,0,0,0,0,0];
let diatonicScales = [];
diatonicScales.group = 'dia';
const hexatonic = [1,1,1,1,1,0,0,0,0,0,0];
let hexatonicScales = [];
hexatonicScales.group = 'hex';
const pentatonic = [1,1,1,1,0,0,0,0,0,0,0];
let pentatonicScales = [];
pentatonicScales.group = 'pen';
const tetratonic = [1,1,1,0,0,0,0,0,0,0,0];
let tetratonicScales = [];
tetratonicScales.group = 'tet';
const tritonic = [1,1,0,0,0,0,0,0,0,0,0];
let tritonicScales = [];
tritonicScales.group = 'tri';

octatonicScales = tryScales(octatonicScales, octatonic);
diatonicScales = tryScales(diatonicScales, diatonic);
hexatonicScales = tryScales(hexatonicScales, hexatonic);
pentatonicScales = tryScales(pentatonicScales, pentatonic);
tetratonicScales = tryScales(tetratonicScales, tetratonic);
tritonicScales = tryScales(tritonicScales, tritonic);

let lastGroup = "";
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let radius = canvas.height / 2;



makeUI();







$('body').on('mousedown', '.btn_key', function() {
    let rootNote = $(this).text();
    rootNote = rootNote.replace('♭','b');
    let mode = $(this).closest("div").attr('data');
    let notes = getNotes(rootNote, mode.split(","));
    playMode(rootNote, notes);

});

$('body').on('click', '.spn_key', function() {
    let spnTxt = $(this).text();
    let binStr = spnTxt.substring(0,12);
    $("#canvas").empty();
    let newlabels = clone(chromatic_labels);
    $("#canvas").attr('note_labels', newlabels.join(","));
    $("#modeInfo").text(spnTxt);
    loadMode(binStr.split(""), newlabels);
});

$('body').on('click', '#closeModal', function() {
    $("#myModal").hide();
});

$('body').on('click', '#closeModal2', function() {
    $("#myModal2").hide();
});


$('body').on('click', '#helpLabel', function() {
    $("#myModal2").show();
});

$('body').on('keyup', '#mode_filter', function() {

    let input = $("#mode_filter").val();
    
    if(input === ""){
        
        $('.mdv').show();
        $('.spacer').show();
        return;
    }
    let inputArr = input.split(",");
    
    $(".spn_key").each(function(index){
        let found = false;
        for(let i = 0; i < inputArr.length; i++){
            if(inputArr[i].length > 0 && $(this).text().indexOf(inputArr[i]) !== -1){
                found = true;
                break;
            }
        }
        if(found){
            $(this).closest("div")
                .show()
                .next(".spacer").show();
        }else{
            $(this).closest("div")
            .hide()
            .next(".spacer").hide();
        }
    });
});


$('body').on('click', '#rotateMode', function(){
    let notes = $("#canvas").attr('notes').split("");
    let labels = $("#canvas").attr('note_labels').split(",");
    let newlabels = [];
    let mem = labels[0];
    for(let i = 1; i < labels.length; i++){
        newlabels.push(labels[i]);
    }
    newlabels.push(mem);
    $("#canvas").attr('note_labels', newlabels.join(","));
    loadMode(notes, newlabels);
});





function loadMode(notes, labels){
    $("#canvas").remove();
    $("#myModalContent").append('<canvas modeInfo="" note_labels="' + labels + '" notes="' + notes.join("") + '" id="canvas" width="300" height="300" style="background-color:#333"></canvas>');
    canvas = document.getElementById("canvas");
    ctx = canvas.getContext("2d");   
    radius = canvas.height / 2;
    ctx.translate(radius, radius);
    radius = radius * 0.90
    drawPolygon(notes,labels);
    $("#myModal").show();
}

function drawPolygon(notes,labels) {
    drawFace(ctx, radius);
    drawNotes(ctx, radius, notes,labels);
}

function drawNotes(ctx, radius, notes, labels) {
    let ang;
    let num;
    ctx.font = radius*0.15 + "px arial";
    ctx.textBaseline="middle";
    ctx.textAlign="center";
    
    for(num= 0; num < 12; num++){
        ang = num * Math.PI / 6;
        ctx.rotate(ang);
        ctx.translate(0, -radius*0.85);
        ctx.rotate(-ang);

        if(num === 0){
            ctx.beginPath();
            ctx.arc(0, 0, radius*0.12, 0, 2*Math.PI);
            ctx.fillStyle = '#9627ff';
            ctx.fill();
        }


        ctx.beginPath();
        ctx.arc(0, 0, radius*0.1, 0, 2*Math.PI);
        ctx.fillStyle = '#333';
        ctx.fill();
        
        ctx.fillStyle = "white";
        if(notes[num] === '1'){ ctx.fillText(labels[num], 0, 0); }
        ctx.rotate(ang);
        ctx.translate(0, radius*0.85);
        ctx.rotate(-ang);
    }
}

function drawFace(ctx, radius) {
    let grad;

    ctx.beginPath();
    ctx.arc(0, 0, radius, 0, 2*Math.PI);
    ctx.fillStyle = 'black';
    ctx.fill();

    grad = ctx.createRadialGradient(0,0,radius*0.95, 0,0,radius*1.05);
    grad.addColorStop(0, '#333');
    grad.addColorStop(0.5, 'white');
    grad.addColorStop(1, '#333');
    ctx.strokeStyle = grad;
    ctx.lineWidth = radius*0.017;
    ctx.stroke();

}


function playMode(rootNote, notesArr){    

    notesArr = shuffle(notesArr);

    notesArr = randomlyRepeatNotes(notesArr);

    notesArr = randomlyReshuffle(notesArr);

    notesArr = randomlyShortenPhrase(notesArr);

    notesArr = randomlyPutHoles(notesArr);

    let instrumentName = "acoustic_guitar_nylon";

    MIDI.loadPlugin({
        soundfontUrl: "./soundfont/",
        instrument: instrumentName,
        onprogress: function(state, progress) {
            //console.log(state, progress);
        },
        onsuccess: function() {
            MIDI.programChange(0, MIDI.GM.byName[instrumentName].number);
            let notes = notesArr;
            let delayt = randomlyGoHalfTime();
            if($('input[name=play_style]:checked').val() == 'chord'){
                delayt = 0;
            }
            let delay = Array(notes.length).fill(delayt);
            let tmpdelay= 0;
            let ctxtime = MIDI.getContext().currentTime;
            let channel = 0;

            let velocity = lastVelocity;

            if(Math.floor(Math.random() * 3) === 1){
                velocity = Math.floor(Math.random() * 20 + 80);
                lastVelocity = velocity;
            }

            rootNote = getRandomRootOctave(rootNote);
            
            rootNoteStr = MIDI.keyToNote[rootNote];

            if($('input[name=play_style]:checked').val() !== 'just_fills'){
                MIDI.noteOn(channel, rootNoteStr, velocity + 150,0);
            }
            

            if(delayt === .15){
                notes = randomlyDoubleNotes(notes);
            }
            
            if($('input[name=play_style]:checked').val() != 'root'){
                for(let i=0; i < notes.length; i++){
                    let chordIt = Math.floor(Math.random() * 3);
                    if(chordIt === 1){
                        //let chordIt2 = Math.floor(Math.random() * 3);
                        //if(chordIt2 === 1){
                        //    let harm2 = Math.floor(Math.random() * (notes.length - 1));
                        //    let harm3 = Math.floor(Math.random() * (notes.length - 1));
                        //    MIDI.chordOn(channel, [notes[i],notes[harm2],notes[harm3]], velocity, ctxtime+tmpdelay);
                        //}else{
                            let harm = Math.floor(Math.random() * (notes.length - 1));
                            MIDI.chordOn(channel, [notes[i],notes[harm]], velocity, ctxtime+tmpdelay);
                        //}
                    }else{
                        MIDI.noteOn(channel, notes[i], velocity, ctxtime+tmpdelay);
                    }
                    
                    tmpdelay = tmpdelay + delay[i]
                }
            }


        }
    });
}


function multiDimensionalUnique(arr) {
    let uniques = [];
    let itemsFound = {};
    for(let i = 0, l = arr.length; i < l; i++) {
        let stringified = JSON.stringify(arr[i]);
        if(itemsFound[stringified]) { continue; }
        uniques.push(arr[i]);
        itemsFound[stringified] = true;
    }
    return uniques;
}

function getNotes(rootNote, mode){
    let chrome = R.concat(chromatic, chromatic);
    let start = chrome.indexOf(rootNote);
    let notes = [];
    for(let i = 0; i < 13; i++){
        if(mode[i] === '1'){

            let key = chrome[start + i] + '4';
            let note = MIDI.keyToNote[key]
            notes.push(note);
        }
    }
    return notes;
}

function perc2color(perc) {
	let r, g, b = 0;
	if(perc < 50) {
		r = Math.round(5.1 * perc);
        g = 255;
        b = 128;
	}
	else {
		g = Math.round(510 - 5.10 * perc);
        r = 150;
        b = 255;
	}
	let h = r * 0x10000 + g * 0x100 + b * 0x1;
	return '#' + ('000000' + h.toString(16)).slice(-6);
}


function makeModeUI(modes, div){
    let colorPercent = 100;
    modes = multiDimensionalUnique(modes);
    div.append('<div class="spacer" style="height:8px"></div>');
    for(let i = 0; i < modes.length; i++){
        let mode = modes[i];
        let num  = parseInt(mode.join(""),2);
        num2 = num - 2050;
        num2 = num2 / 15;
        let bgcolor = perc2color(num2);
        if(lastGroup !== mode.group){
            lastGroup = mode.group;
            div.append('<div class="spacer" style="height:5px"></div>');
        }
        let newdiv = $('<div class="mdv" data="' + mode + '" style="background-color:' + bgcolor + '"></div>');
        div.append(newdiv);
        
        newdiv.append('<span class="spn_key">' + mode.join("") + ' (' + num + ') ' + mode.group + '</span data=' + mode + '>')
        .append($('#notes_template_container').html());
    }
}

function makeUI(){
    let div = $("#scales_div");

    makeModeUI(getModes(octatonicScales), div);
    makeModeUI(getModes(diatonicScales), div);
    makeModeUI(getModes(hexatonicScales), div);
    makeModeUI(getModes(pentatonicScales), div);
    makeModeUI(getModes(tetratonicScales), div);
    makeModeUI(getModes(tritonicScales), div);

}



function getModes(scales){
    let modes = [];
    scales.sort();

    for(let i = 0; i < scales.length; i++){
        let scale = scales[i];
        scale = R.concat(scale, scale);
        let newmodes = [];
       
        for(let j = 0; j < scale.length/2; j++){
            
            if(scale[j] === 1){
                let mode = [];
                mode.group = scales.group + '-' + i;
                for(let n = j; n < j + 12; n++){
                    mode.push(scale[n]);
                }
                newmodes.push(mode);
            }
        }
        newmodes.sort()

        modes = R.concat(modes, newmodes);
    }
    //modes.sort();

    return modes;
}



function tryScales(scalesArr, scalesTemplate){
    
    for(let i = 0; i < 5000; i++){
        
        let attempt = shuffle(scalesTemplate);
        attempt = R.concat([1], attempt);
        attemptDoubled = R.concat(attempt,attempt);

        if(checkScale(attemptDoubled)){
            let worked = true;
            for(let j = 0; j < scalesArr.length; j++){
                let strScale = scalesArr[j].join("");
                strScale += strScale;
                let strAttempt = attempt.join("");
                if(strScale.indexOf(strAttempt) !== -1){
                    if(scalesArr[j] > attempt){
                        scalesArr[j] = attempt;
                    }
                    worked = false;
                }
            }
            if(worked){
                scalesArr.push(attempt);
            }
        }
    }

    return scalesArr;
}


function shuffle(array) {
    let currentIndex = array.length, temporaryValue, randomIndex;
  
    // While there remain elements to shuffle...
    while (0 !== currentIndex) {
  
      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;
  
      // And swap it with the current element.
      temporaryValue = array[currentIndex];
      array[currentIndex] = array[randomIndex];
      array[randomIndex] = temporaryValue;
    }
  
    return array;
}

function checkScale(scale){
    for(let i = 0; i < scale.length; i++){
        if(scale[i] === 1 && scale[i+1] === 1 && scale[i+2] === 1){
            return false;
        }
    }
    return true;
}


function fillModes(){
    for(let i = 0; i < scales.length; i++){
        let scale = scales[i];
        let notesPerOctave = scale.notesPerOctave;
        let notes = [];
        for(let j = 0; j < notesPerOctave; j++){

        }
    }
}        


function randomlyRepeatNotes(notesArr){
    notesArr = clone(notesArr);
    let loopTimes = Math.floor(Math.random() * (notesArr.length));
    for(let lp = 0; lp < loopTimes; lp++){
        let randomNote = Math.floor(Math.random() * (notesArr.length - 1));
        notesArr[randomNote + 1] = notesArr[randomNote];
    }
    return notesArr;
}

function randomlyReshuffle(notesArr){
    notesArr = clone(notesArr);
    let reshuf = Math.floor(Math.random() * 2);
    
    if(reshuf === 1){
        notesArr = shuffle(notesArr);
    }
    return notesArr;
}

function randomlyShortenPhrase(notesArr){
    notesArr = clone(notesArr);
    let doStrip =  Math.floor(Math.random() * 3);
    if(doStrip === 1){
        let stripEnd = Math.floor(Math.random() * (notesArr.length - 1));
        while(stripEnd > 0){
            notesArr.pop();
            stripEnd--;
        }
    }
    return notesArr;
}

function randomlyPutHoles(notesArr){
    notesArr = clone(notesArr);
    let putHoles = Math.floor(Math.random() * 4);
    if(putHoles === 1 || putHoles === 2 || putHoles === 3){
        let numHoles = Math.floor(Math.random() * (notesArr.length - 3));
        numHoles = numHoles + 2;
        while(numHoles > 0){
            let pHole = Math.floor(Math.random() * (notesArr.length - 1));
            notesArr[pHole] = 0;
            numHoles--;
        }           
    }
    return notesArr;
}

function randomlyGoHalfTime(){      
    let mydelayT = Math.floor(Math.random() * 2);
    let delayt = .3;
    if(mydelayT === 1){
        delayt = .15;
    }
    return delayt;
}

function getRandomRootOctave(note){
    let rootOctR = Math.floor(Math.random() * 3);
    if(rootOctR === 1){
        return note + '2';
    }else{
        return note + '1';
    }
}

function randomlyDoubleNotes(notes){
    let connotes = clone(notes);
    if(Math.floor(Math.random() * 3) === 1){
        connotes.reverse();
    }else if(Math.floor(Math.random() * 3) === 2){
        connotes = shuffle(connotes);
    }

    let bs = Math.floor(Math.random() * 3);
    if(bs === 0){
        notes = notes.concat(connotes);
    }
    return notes;
}

function clone(obj){
    return JSON.parse(JSON.stringify(obj));
}

    </script>
    <br><br><br>
    </body>

    
</html>





